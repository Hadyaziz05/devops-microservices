pipeline {
    agent {
        node {
            label 'jenkins-docker-agent'
        }
    }

    triggers {
        pollSCM 'H/5 * * * *'
    }

    environment {
        TAG = "v${env.BUILD_NUMBER}" // Dynamic image tag
        IMAGE = "hadyaziz05/frontend:${TAG}"
        DOCKER_HOST = 'tcp://docker-socat:2375'
    }

    stages {
        stage('Build') {
            steps {
                echo "Building Docker Image: ${IMAGE}"
                sh '''
                docker build -t $IMAGE frontend/
                '''
            }
        }

        stage('Test') {
            steps {
                echo "Running simple container test..."
                sh '''
                docker run --rm $IMAGE serve --version
                '''
            }
        }

        stage('Deliver') {
            steps {
                echo "Pushing to Docker Hub and updating Kubernetes..."
                withCredentials([usernamePassword(credentialsId: 'dockerhub-creds', usernameVariable: 'USER', passwordVariable: 'PASS')]) {
                    sh '''
                    echo "$PASS" | docker login -u "$USER" --password-stdin
                    docker push $IMAGE
                    '''
                }

                // Set image in Kubernetes deployment
                sh '''
                echo "Updating deployment with new image..."
                kubectl set image deployment/frontend-deployment frontend=$IMAGE

                echo "Waiting for rollout to complete..."
                kubectl rollout status deployment/frontend-deployment
                '''
            }
        }
    }
}
